<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LD Debate Practice Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .setup-section, .debate-section, .results-section {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        input[type="text"], textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-option input[type="radio"] {
            width: 20px;
            height: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .debate-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .timer {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }

        .timer-display {
            font-size: 3em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
        }

        .timer-label {
            font-size: 1.2em;
            color: #666;
        }

        .speech-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .speech-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .speech-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
        }

        .voice-controls {
            display: flex;
            gap: 10px;
        }

        .voice-btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .voice-btn.record {
            background: #e74c3c;
            color: white;
        }

        .voice-btn.record.active {
            background: #c0392b;
            animation: pulse 1.5s infinite;
        }

        .voice-btn.listen {
            background: #3498db;
            color: white;
        }

        .voice-btn.listen.active {
            background: #2980b9;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .transcript {
            background: white;
            padding: 15px;
            border-radius: 6px;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            white-space: pre-wrap;
        }

        .transcript.empty {
            color: #999;
            font-style: italic;
        }

        .status-indicator {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-ready {
            background: #d4edda;
            color: #155724;
        }

        .status-active {
            background: #fff3cd;
            color: #856404;
        }

        .status-complete {
            background: #cce5ff;
            color: #004085;
        }

        .feedback-section {
            margin-top: 20px;
        }

        .feedback-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .feedback-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .score-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .score-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
        }

        .score-value {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
        }

        .feedback-text {
            line-height: 1.8;
            color: #555;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #f5c6cb;
        }

        .info-box {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì LD Debate Practice Agent</h1>
            <p>Practice Lincoln-Douglas debate with AI opponent and judge</p>
        </div>

        <!-- Setup Section -->
        <div id="setupSection" class="setup-section">
            <div class="info-box" style="background: #fff3cd; border-left-color: #ffc107; color: #856404; margin-bottom: 20px;">
                <strong>üì• IMPORTANT: Download & Setup Instructions</strong>
                <ol style="margin: 10px 0 10px 20px; line-height: 1.8;">
                    <li><strong>Download this HTML file</strong> using the download button</li>
                    <li><strong>Open the downloaded file in Chrome or Edge browser</strong> (NOT Safari, NOT in Claude.ai)</li>
                    <li><strong>Get your Anthropic API key:</strong>
                        <ul style="margin: 5px 0 5px 20px;">
                            <li>Go to <a href="https://console.anthropic.com/" target="_blank">console.anthropic.com</a></li>
                            <li>Sign up or log in</li>
                            <li>Go to "API Keys" section</li>
                            <li>Click "Create Key" and copy it</li>
                        </ul>
                    </li>
                    <li><strong>Enter API key below ONCE</strong> - it will be saved automatically on this device!</li>
                    <li><strong>Allow microphone</strong> when prompted for recording to work</li>
                </ol>
                <p style="margin-top: 10px; font-size: 0.95em;">
                    üí° <strong>Pro tip:</strong> Upload this file to GitHub Pages or any web host so you can access it from any device with just a URL!
                </p>
            </div>

            <div class="form-group" style="background: #e3f2fd; padding: 20px; border-radius: 8px; border-left: 4px solid #2196f3; margin-bottom: 20px;">
                <label for="apiKey" style="color: #0d47a1; font-size: 1.1em;" id="apiKeyLabel">
                    üîë Anthropic API Key <span style="color: #d32f2f;">*Required for AI features</span>
                </label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input 
                        type="password" 
                        id="apiKey" 
                        placeholder="sk-ant-api03-..."
                        style="font-family: monospace; margin-top: 10px; flex: 1;"
                    >
                    <button 
                        onclick="clearApiKey()" 
                        style="margin-top: 10px; padding: 12px 20px; background: #f44336; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;"
                        title="Clear saved API key"
                    >
                        Clear
                    </button>
                </div>
                <small style="display: block; margin-top: 8px; color: #666;">
                    Your API key is stored locally in your browser and only used to call Anthropic's API. You only need to enter it once per device.
                    <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color: #2196f3;">Get your API key here</a>
                </small>
            </div>

            <h2 style="margin-bottom: 20px;">Debate Setup</h2>
            
            <div class="form-group">
                <label for="resolution">Resolution</label>
                <textarea id="resolution" placeholder="Enter the debate resolution (e.g., 'Resolved: The United States ought to prioritize individual liberty over national security')"></textarea>
            </div>

            <div class="form-group">
                <label>Your Position</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="affirmative" name="position" value="affirmative" checked>
                        <label for="affirmative">Affirmative (For)</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="negative" name="position" value="negative">
                        <label for="negative">Negative (Against)</label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="difficultyLevel">Difficulty Level (NSDA Tournament Style)</label>
                <select id="difficultyLevel">
                    <option value="novice">Novice - First year debater, basic arguments</option>
                    <option value="jv">Junior Varsity - Developing skills, moderate complexity</option>
                    <option value="varsity" selected>Varsity - Advanced arguments, strong clash</option>
                    <option value="national">National Circuit - Complex philosophy, dense theory</option>
                    <option value="toc">TOC/Elite - Highest level, intricate frameworks</option>
                </select>
                <small style="color: #666; margin-top: 5px; display: block;">
                    This adjusts the agent's argument complexity, philosophy depth, and debate speed
                </small>
            </div>

            <div class="form-group">
                <label for="studentName">Your Name</label>
                <input type="text" id="studentName" placeholder="Enter your name">
            </div>

            <button class="btn" onclick="startDebate()">Start Debate</button>
        </div>

        <!-- Debate Section -->
        <div id="debateSection" class="debate-section hidden">
            <div class="info-box" style="margin-bottom: 20px; background: #e8f5e9; border-left-color: #4caf50; color: #2e7d32;">
                <strong>‚úÖ You're all set!</strong> Now you can practice real debate with voice recording and AI opponent. Remember to allow microphone access when prompted.
            </div>

            <div class="timer">
                <div class="timer-display" id="timerDisplay">0:00</div>
                <div class="timer-label" id="timerLabel">Preparing...</div>
            </div>

            <div class="debate-controls">
                <button class="btn" onclick="startTimer()" id="startTimerBtn">Start Timer</button>
                <button class="btn btn-secondary" onclick="pauseTimer()" id="pauseTimerBtn" disabled>Pause Timer</button>
                <button class="btn btn-secondary" onclick="resetTimer()" id="resetTimerBtn">Reset Timer</button>
                <button class="btn btn-success" onclick="nextSpeech()" id="nextSpeechBtn">Next Speech</button>
            </div>

            <div id="currentSpeech" class="speech-section">
                <!-- Speech content will be inserted here -->
            </div>

            <div id="loadingIndicator" class="loading hidden">
                <div class="spinner"></div>
                <p>Processing...</p>
            </div>

            <button class="btn btn-success" onclick="finishDebate()" id="finishDebateBtn">Finish Debate & Get Feedback</button>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="results-section hidden">
            <h2 style="margin-bottom: 20px;">Debate Results & Feedback</h2>
            <div id="feedbackContent">
                <!-- Feedback will be inserted here -->
            </div>
            <button class="btn" onclick="resetDebate()">Start New Debate</button>
        </div>
    </div>

    <script>
        let debateState = {
            resolution: '',
            studentPosition: 'affirmative',
            studentName: '',
            difficultyLevel: 'varsity',
            apiKey: '',
            currentSpeechIndex: 0,
            speeches: [],
            timerInterval: null,
            currentTime: 0,
            isTimerRunning: false,
            recognition: null,
            synthesis: window.speechSynthesis,
            isRecording: false,
            isListening: false
        };

        // Load saved API key on page load
        window.addEventListener('DOMContentLoaded', () => {
            const savedApiKey = localStorage.getItem('anthropic_api_key');
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
                // Show a subtle indicator that key is loaded
                const apiKeyInput = document.getElementById('apiKey');
                apiKeyInput.style.borderColor = '#4caf50';
                const label = document.getElementById('apiKeyLabel');
                if (label) {
                    label.innerHTML = 'üîë Anthropic API Key <span style="color: #4caf50;">‚úì Saved</span>';
                }
            }
        });

        function clearApiKey() {
            if (confirm('Are you sure you want to clear the saved API key? You will need to enter it again next time.')) {
                localStorage.removeItem('anthropic_api_key');
                document.getElementById('apiKey').value = '';
                document.getElementById('apiKey').style.borderColor = '#e0e0e0';
                const label = document.getElementById('apiKeyLabel');
                if (label) {
                    label.innerHTML = 'üîë Anthropic API Key <span style="color: #d32f2f;">*Required for AI features</span>';
                }
                alert('API key cleared successfully!');
            }
        }

        const speechStructure = [
            { name: 'Affirmative Constructive', duration: 360, speaker: 'affirmative' },
            { name: 'Negative Cross-Examination', duration: 180, speaker: 'negative' },
            { name: 'Negative Constructive', duration: 420, speaker: 'negative' },
            { name: 'Affirmative Cross-Examination', duration: 180, speaker: 'affirmative' },
            { name: 'First Affirmative Rebuttal', duration: 240, speaker: 'affirmative' },
            { name: 'Negative Rebuttal', duration: 360, speaker: 'negative' },
            { name: 'Second Affirmative Rebuttal', duration: 180, speaker: 'affirmative' }
        ];

        // Load voices when they become available
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = () => {
                speechSynthesis.getVoices();
            };
        }

        // Initialize speech recognition
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                debateState.recognition = new SpeechRecognition();
                debateState.recognition.continuous = true;
                debateState.recognition.interimResults = true;
                debateState.recognition.lang = 'en-US';

                debateState.recognition.onresult = (event) => {
                    let finalTranscript = '';
                    let interimTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    const transcriptEl = document.getElementById('studentTranscript');
                    if (!transcriptEl) {
                        console.error('Student transcript element not found');
                        return;
                    }
                    
                    const currentSpeech = debateState.speeches[debateState.currentSpeechIndex];
                    
                    if (finalTranscript) {
                        currentSpeech.studentText = (currentSpeech.studentText || '') + finalTranscript;
                    }
                    
                    transcriptEl.textContent = (currentSpeech.studentText || '') + interimTranscript;
                    transcriptEl.classList.remove('empty');
                };

                debateState.recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    if (event.error === 'not-allowed') {
                        alert('üé§ Microphone access denied.\n\nTo fix this:\n1. Click the üîí lock icon in your browser address bar\n2. Change microphone permission to "Allow"\n3. Refresh the page\n\nOR simply click "Type Speech" button to type instead of recording.');
                    } else if (event.error === 'no-speech') {
                        // User stopped speaking, this is normal
                        console.log('No speech detected');
                    } else {
                        console.log('Speech recognition error: ' + event.error);
                    }
                    stopRecording();
                };

                debateState.recognition.onend = () => {
                    // If recording was still supposed to be active, restart it
                    if (debateState.isRecording) {
                        try {
                            debateState.recognition.start();
                        } catch (e) {
                            console.error('Error restarting recognition:', e);
                            debateState.isRecording = false;
                            const btn = document.getElementById('recordBtn');
                            if (btn) {
                                btn.textContent = 'üé§ Record';
                                btn.classList.remove('active');
                            }
                        }
                    }
                };
            }
        }

        function startDebate() {
            const resolution = document.getElementById('resolution').value.trim();
            const position = document.querySelector('input[name="position"]:checked').value;
            const name = document.getElementById('studentName').value.trim();
            const difficulty = document.getElementById('difficultyLevel').value;
            const apiKey = document.getElementById('apiKey').value.trim();

            if (!resolution || !name) {
                alert('Please fill in resolution and your name');
                return;
            }

            if (!apiKey) {
                alert('‚ö†Ô∏è API Key Required\n\nPlease enter your Anthropic API key to enable the AI agent.\n\nGet one at: https://console.anthropic.com/settings/keys');
                return;
            }

            if (!apiKey.startsWith('sk-ant-')) {
                alert('‚ö†Ô∏è Invalid API Key\n\nYour API key should start with "sk-ant-"\n\nPlease check and try again.');
                return;
            }

            // Save API key to localStorage for future use
            localStorage.setItem('anthropic_api_key', apiKey);

            debateState.resolution = resolution;
            debateState.studentPosition = position;
            debateState.studentName = name;
            debateState.difficultyLevel = difficulty;
            debateState.apiKey = apiKey;
            debateState.speeches = speechStructure.map(s => ({
                ...s,
                studentText: '',
                agentText: '',
                completed: false,
                hasBeenRead: false
            }));

            document.getElementById('setupSection').classList.add('hidden');
            document.getElementById('debateSection').classList.remove('hidden');

            initSpeechRecognition();
            displayCurrentSpeech();
        }

        function displayCurrentSpeech() {
            const speech = debateState.speeches[debateState.currentSpeechIndex];
            const isStudentTurn = speech.speaker === debateState.studentPosition;
            
            document.getElementById('timerLabel').textContent = speech.name;
            debateState.currentTime = speech.duration;
            updateTimerDisplay();

            const speechHtml = `
                <div class="speech-header">
                    <div>
                        <span class="speech-title">${speech.name}</span>
                        <span class="status-indicator ${speech.completed ? 'status-complete' : 'status-ready'}">
                            ${speech.completed ? 'Completed' : 'Ready'}
                        </span>
                    </div>
                    <div class="voice-controls">
                        ${isStudentTurn ? `
                            <button class="voice-btn record" onclick="toggleRecording()" id="recordBtn">
                                üé§ Record
                            </button>
                        ` : `
                            <button class="voice-btn listen" onclick="toggleListening()" id="listenBtn">
                                üîä Listen to Agent
                            </button>
                        `}
                    </div>
                </div>
                ${isStudentTurn ? `
                    <div>
                        <p style="margin-bottom: 10px;"><strong>Your turn to speak</strong></p>
                        <div class="voice-controls" style="margin-bottom: 15px; justify-content: flex-start;">
                            <button class="voice-btn record" onclick="toggleRecording()" id="recordBtn">
                                üé§ Record
                            </button>
                            <span style="margin: 0 10px; color: #999;">OR</span>
                            <button class="voice-btn" style="background: #9c27b0;" onclick="toggleManualInput()" id="manualInputBtn">
                                ‚å®Ô∏è Type Speech
                            </button>
                        </div>
                        <div id="studentTranscript" class="transcript empty">Click Record to begin speaking, or Type Speech to enter text manually...</div>
                        <textarea id="manualInput" class="transcript" style="display: none; min-height: 150px; font-family: inherit;" placeholder="Type your speech here..."></textarea>
                    </div>
                ` : `
                    <div>
                        <p style="margin-bottom: 10px;"><strong>Agent's turn to speak</strong></p>
                        ${!speech.agentText ? `
                            <div id="agentStatus" class="transcript empty">
                                <div class="spinner" style="width: 30px; height: 30px; margin: 20px auto;"></div>
                                <p style="text-align: center;">Preparing agent's speech...</p>
                            </div>
                        ` : speech.hasBeenRead ? `
                            <div id="agentTranscript" class="transcript">${speech.agentText}</div>
                        ` : `
                            <div id="agentStatus" class="transcript" style="background: #e8f5e9; border-color: #4caf50;">
                                <p style="text-align: center; font-size: 1.2em; color: #2e7d32; margin: 30px 0;">
                                    ‚úÖ <strong>Agent is ready to speak!</strong><br>
                                    <span style="font-size: 0.9em; font-style: italic;">Click "Listen to Agent" above to hear the speech.</span>
                                </p>
                            </div>
                        `}
                    </div>
                `}
            `;

            document.getElementById('currentSpeech').innerHTML = speechHtml;

            // If it's agent's turn and they haven't spoken yet, generate response
            if (!isStudentTurn && !speech.agentText) {
                generateAgentSpeech();
            }
            // Note: The HTML template above already handles displaying transcript for hasBeenRead speeches
        }

        function toggleRecording() {
            if (debateState.isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            if (!debateState.recognition) {
                alert('Speech recognition not supported in this browser. Please use Chrome, Edge, or Safari.');
                return;
            }

            try {
                debateState.isRecording = true;
                debateState.recognition.start();
                
                const btn = document.getElementById('recordBtn');
                if (btn) {
                    btn.textContent = '‚èπÔ∏è Stop Recording';
                    btn.classList.add('active');
                }
            } catch (error) {
                console.error('Error starting recording:', error);
                debateState.isRecording = false;
                alert('Could not start recording. Error: ' + error.message);
            }
        }

        function stopRecording() {
            if (debateState.recognition && debateState.isRecording) {
                try {
                    debateState.recognition.stop();
                } catch (error) {
                    console.error('Error stopping recording:', error);
                }
                debateState.isRecording = false;
                
                const btn = document.getElementById('recordBtn');
                if (btn) {
                    btn.textContent = 'üé§ Record';
                    btn.classList.remove('active');
                }
            }
        }

        function toggleManualInput() {
            const manualInput = document.getElementById('manualInput');
            const transcript = document.getElementById('studentTranscript');
            const btn = document.getElementById('manualInputBtn');
            const currentSpeech = debateState.speeches[debateState.currentSpeechIndex];

            if (manualInput.style.display === 'none') {
                // Show manual input
                manualInput.style.display = 'block';
                transcript.style.display = 'none';
                btn.textContent = 'üíæ Save Speech';
                btn.style.background = '#4caf50';
                manualInput.value = currentSpeech.studentText || '';
                manualInput.focus();
            } else {
                // Save and hide manual input
                currentSpeech.studentText = manualInput.value;
                transcript.textContent = currentSpeech.studentText;
                transcript.classList.remove('empty');
                manualInput.style.display = 'none';
                transcript.style.display = 'block';
                btn.textContent = '‚å®Ô∏è Type Speech';
                btn.style.background = '#9c27b0';
            }
        }

        async function generateAgentSpeech() {
            const speech = debateState.speeches[debateState.currentSpeechIndex];
            const agentPosition = debateState.studentPosition === 'affirmative' ? 'negative' : 'affirmative';
            
            document.getElementById('loadingIndicator').classList.remove('hidden');

            // Build context from previous speeches
            let context = `Resolution: ${debateState.resolution}\n\n`;
            context += `You are debating the ${agentPosition} side.\n\n`;
            context += `Current speech: ${speech.name}\n\n`;
            
            if (debateState.currentSpeechIndex > 0) {
                context += 'Previous speeches:\n';
                for (let i = 0; i < debateState.currentSpeechIndex; i++) {
                    const prevSpeech = debateState.speeches[i];
                    const speakerName = prevSpeech.speaker === debateState.studentPosition ? debateState.studentName : 'Agent';
                    const text = prevSpeech.speaker === debateState.studentPosition ? prevSpeech.studentText : prevSpeech.agentText;
                    if (text) {
                        context += `\n${prevSpeech.name} (${speakerName}):\n${text}\n`;
                    }
                }
            }

            // Difficulty-specific instructions
            const difficultyInstructions = {
                'novice': `You are debating at a NOVICE level (first-year debater). Use:
- Clear, straightforward arguments that are easy to understand
- Basic value/criterion framework (e.g., Morality/Utilitarianism)
- Simple real-world examples and common knowledge
- Direct clash with opponent's main points
- Avoid complex philosophy or theory
- Speak at a moderate, clear pace
- Focus on 2-3 main contentions maximum`,

                'jv': `You are debating at a JUNIOR VARSITY level (developing debater). Use:
- Moderately complex arguments with some nuance
- Standard frameworks with brief philosophical justification (Kant, Mill, Rawls)
- Mix of real-world examples and basic philosophical arguments
- Engage with opponent's framework and main contentions
- Occasional use of debate terminology (extend, turn, outweigh)
- Include some warranted analysis
- 3-4 contentions with subpoints`,

                'varsity': `You are debating at a VARSITY level (advanced high school). Use:
- Sophisticated philosophical frameworks (Kant's deontology, consequentialism, contractarianism)
- Strong warranting and impact analysis
- Strategic framework interaction and weighing
- Technical debate vocabulary (a priori, pre-fiat, empirics)
- Mix of philosophical and practical arguments
- Strong clash and line-by-line responses
- Dense but clear argumentation`,

                'national': `You are debating at a NATIONAL CIRCUIT level (top national competition). Use:
- Complex philosophical positions (Levinas, Foucault, critical theory)
- Dense framework debate with meta-ethics
- Theory arguments when appropriate (fairness, education)
- Abstract impact calculus and weighing mechanisms
- Advanced debate theory and strategy
- Fast-paced, technical argumentation
- Layered argument structure with extensive warranting`,

                'toc': `You are debating at TOC/ELITE level (Tournament of Champions caliber). Use:
- Cutting-edge philosophical literature and critical theory
- Intricate framework interaction and burden structures
- Theory shells and tricks when strategic
- Meta-ethical discussions and skepticism
- Dense warranting chains and complex link stories
- Advanced weighing mechanisms (meta-weighing, role of the ballot)
- Extremely technical and fast-paced
- Multiple layers of argumentation and pre-empts`
            };

            const levelInstruction = difficultyInstructions[debateState.difficultyLevel];

            console.log('Attempting to generate agent speech...');
            console.log('Agent position:', agentPosition);
            console.log('Difficulty level:', debateState.difficultyLevel);

            try {
                console.log('Making API call via Cloudflare Worker...');
                
                const requestBody = {
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 1000,
                    messages: [{
                        role: 'user',
                        content: `${context}\n\n${levelInstruction}\n\nProvide a strong, well-structured speech for the ${speech.name}. Make compelling arguments for the ${agentPosition} position at the ${debateState.difficultyLevel.toUpperCase()} level. Keep it concise and powerful (aim for 2-3 minutes when spoken). Match the complexity and style to the difficulty level specified.`
                    }]
                };
                
                console.log('Request body:', JSON.stringify(requestBody, null, 2));
                
                // Use Cloudflare Worker proxy instead of direct API call
                const response = await fetch('https://debate-api-proxy.balaji-ganesan03.workers.dev', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': debateState.apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API error response:', errorText);
                    
                    let errorMessage = `API request failed: ${response.status}`;
                    try {
                        const errorJson = JSON.parse(errorText);
                        if (errorJson.error && errorJson.error.message) {
                            errorMessage += ` - ${errorJson.error.message}`;
                        }
                    } catch (e) {
                        errorMessage += ` - ${errorText.substring(0, 200)}`;
                    }
                    
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log('API response received:', data);
                
                // Validate response structure
                if (!data.content || !Array.isArray(data.content) || data.content.length === 0) {
                    console.error('Invalid response structure:', data);
                    throw new Error('Invalid response format from API');
                }
                
                speech.agentText = data.content[0].text;
                console.log('Agent speech generated successfully');
                
                // Update the status to show agent is ready
                const statusEl = document.getElementById('agentStatus');
                if (statusEl) {
                    statusEl.innerHTML = `
                        <p style="text-align: center; font-size: 1.2em; color: #2e7d32; margin: 30px 0;">
                            ‚úÖ <strong>Agent is ready to speak!</strong><br>
                            <span style="font-size: 0.9em; font-style: italic;">Click "Listen to Agent" above to hear the speech.</span>
                        </p>
                    `;
                    statusEl.style.background = '#e8f5e9';
                    statusEl.style.borderColor = '#4caf50';
                    statusEl.classList.remove('empty');
                }
            } catch (error) {
                console.error('Error generating agent speech:', error);
                const statusEl = document.getElementById('agentStatus');
                if (statusEl) {
                    statusEl.innerHTML = `
                        <p style="text-align: center; color: #c62828; margin: 20px;">
                            ‚ùå <strong>Error generating speech</strong><br>
                            <span style="font-size: 0.9em;">${error.message}</span><br>
                            <span style="font-size: 0.8em; color: #666;">Check browser console (F12) for details</span><br>
                            <button onclick="generateAgentSpeech()" style="margin-top: 15px; padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                Try Again
                            </button>
                        </p>
                    `;
                    statusEl.style.background = '#ffebee';
                    statusEl.style.borderColor = '#e57373';
                }
            } finally {
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        }

        function toggleListening() {
            if (debateState.isListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        function startListening() {
            const speech = debateState.speeches[debateState.currentSpeechIndex];
            if (!speech.agentText) {
                alert('Agent speech not yet generated. Please wait.');
                return;
            }

            // Cancel any ongoing speech
            if (debateState.synthesis.speaking) {
                debateState.synthesis.cancel();
            }
            
            // Wait a moment for cancellation to complete
            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance(speech.agentText);
                
                // Adjust voice characteristics based on difficulty level
                const voiceSettings = {
                    'novice': { 
                        rate: 1.3,  // Faster, trying to rush through
                        pitch: 1.1, // Slightly higher pitch (younger student)
                        volume: 1
                    },
                    'jv': { 
                        rate: 1.2,  // Still fast but more controlled
                        pitch: 1.05,
                        volume: 1
                    },
                    'varsity': { 
                        rate: 1.15, // Moderate speed, confident
                        pitch: 1.0,
                        volume: 1
                    },
                    'national': { 
                        rate: 1.4,  // Very fast (spreading)
                        pitch: 0.98,
                        volume: 1
                    },
                    'toc': { 
                        rate: 1.5,  // Extremely fast (heavy spreading)
                        pitch: 0.95,
                        volume: 1
                    }
                };

                const settings = voiceSettings[debateState.difficultyLevel] || voiceSettings.varsity;
                utterance.rate = settings.rate;
                utterance.pitch = settings.pitch;
                utterance.volume = settings.volume;
                
                // Get available voices and prefer English voices
                const voices = debateState.synthesis.getVoices();
                const englishVoice = voices.find(voice => voice.lang.startsWith('en'));
                if (englishVoice) {
                    utterance.voice = englishVoice;
                }
                
                utterance.onstart = () => {
                    debateState.isListening = true;
                    const btn = document.getElementById('listenBtn');
                    if (btn) {
                        btn.textContent = '‚èπÔ∏è Stop Listening';
                        btn.classList.add('active');
                    }
                };

                utterance.onend = () => {
                    stopListening();
                    // Mark as read and reveal the transcript after speaking is complete
                    speech.hasBeenRead = true;
                    
                    // Replace the status message with the actual transcript
                    const statusEl = document.getElementById('agentStatus');
                    if (statusEl) {
                        statusEl.id = 'agentTranscript';
                        statusEl.textContent = speech.agentText;
                        statusEl.style.background = 'white';
                        statusEl.style.borderColor = '#e0e0e0';
                        statusEl.classList.remove('empty');
                    }
                };

                utterance.onerror = (event) => {
                    console.error('Speech synthesis error:', event);
                    stopListening();
                    
                    // Show the transcript immediately if speech fails
                    speech.hasBeenRead = true;
                    const statusEl = document.getElementById('agentStatus');
                    if (statusEl) {
                        statusEl.id = 'agentTranscript';
                        statusEl.innerHTML = `
                            <div style="background: #fff3cd; padding: 10px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid #ffc107;">
                                <strong>‚ö†Ô∏è Text-to-speech not available</strong> - Reading the transcript instead
                            </div>
                            <div style="white-space: pre-wrap;">${speech.agentText}</div>
                        `;
                        statusEl.style.background = 'white';
                        statusEl.style.borderColor = '#e0e0e0';
                        statusEl.classList.remove('empty');
                    }
                };

                debateState.synthesis.speak(utterance);
            }, 100);
        }

        function stopListening() {
            if (debateState.synthesis.speaking) {
                debateState.synthesis.cancel();
            }
            debateState.isListening = false;
            const btn = document.getElementById('listenBtn');
            if (btn) {
                btn.textContent = 'üîä Listen to Agent';
                btn.classList.remove('active');
            }
        }

        function startTimer() {
            if (!debateState.isTimerRunning) {
                debateState.isTimerRunning = true;
                debateState.timerInterval = setInterval(() => {
                    debateState.currentTime--;
                    updateTimerDisplay();
                    
                    if (debateState.currentTime <= 0) {
                        pauseTimer();
                        alert('Time is up for this speech!');
                    }
                }, 1000);

                document.getElementById('startTimerBtn').disabled = true;
                document.getElementById('pauseTimerBtn').disabled = false;
            }
        }

        function pauseTimer() {
            if (debateState.isTimerRunning) {
                clearInterval(debateState.timerInterval);
                debateState.isTimerRunning = false;
                document.getElementById('startTimerBtn').disabled = false;
                document.getElementById('pauseTimerBtn').disabled = true;
            }
        }

        function resetTimer() {
            pauseTimer();
            const speech = debateState.speeches[debateState.currentSpeechIndex];
            debateState.currentTime = speech.duration;
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(debateState.currentTime / 60);
            const seconds = debateState.currentTime % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function nextSpeech() {
            stopRecording();
            stopListening();
            pauseTimer();

            debateState.speeches[debateState.currentSpeechIndex].completed = true;
            debateState.currentSpeechIndex++;

            if (debateState.currentSpeechIndex >= debateState.speeches.length) {
                finishDebate();
            } else {
                displayCurrentSpeech();
            }
        }

        async function finishDebate() {
            stopRecording();
            stopListening();
            pauseTimer();

            document.getElementById('debateSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('feedbackContent').innerHTML = '<div class="loading"><div class="spinner"></div><p>Generating comprehensive feedback...</p></div>';

            // Compile full debate transcript
            let transcript = `Resolution: ${debateState.resolution}\n\n`;
            transcript += `Student: ${debateState.studentName} (${debateState.studentPosition})\n`;
            transcript += `Difficulty Level: ${debateState.difficultyLevel.toUpperCase()}\n\n`;
            
            debateState.speeches.forEach(speech => {
                const speakerName = speech.speaker === debateState.studentPosition ? debateState.studentName : 'Agent';
                const text = speech.speaker === debateState.studentPosition ? speech.studentText : speech.agentText;
                transcript += `\n=== ${speech.name} (${speakerName}) ===\n${text || '(No content recorded)'}\n`;
            });

            // Difficulty-specific judging criteria
            const judgingContext = {
                'novice': 'Judge this as a NOVICE round. Look for: clear communication, basic understanding of the resolution, simple argument structure, appropriate use of values/criteria. Be encouraging and focus on foundational skills.',
                'jv': 'Judge this as a JV round. Look for: developing argumentation skills, framework engagement, basic warranting, some technical vocabulary, moderate complexity. Balance critique with encouragement.',
                'varsity': 'Judge this as a VARSITY round. Look for: sophisticated frameworks, strong warranting, technical debate skills, strategic choices, clash and weighing. Expect high-quality argumentation.',
                'national': 'Judge this as a NATIONAL CIRCUIT round. Look for: complex philosophy, dense argumentation, theory when appropriate, advanced strategy, technical proficiency. Hold to high standards.',
                'toc': 'Judge this as a TOC/ELITE round. Look for: cutting-edge philosophical positions, intricate framework debate, theory and tricks, meta-ethics, extremely technical execution. Apply the highest standards of competitive debate.'
            };

            try {
                // Use Cloudflare Worker proxy instead of direct API call
                const response = await fetch('https://debate-api-proxy.balaji-ganesan03.workers.dev', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': debateState.apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 2000,
                        messages: [{
                            role: 'user',
                            content: `You are an experienced Lincoln-Douglas debate judge at the ${debateState.difficultyLevel.toUpperCase()} level. ${judgingContext[debateState.difficultyLevel]}\n\nEvaluate this debate:\n\n${transcript}\n\nProvide:\n1. Scores (0-30) for both the student and agent on: Arguments, Evidence, Clash, Organization, and Delivery\n2. Winner declaration with reasoning (consider difficulty level expectations)\n3. Specific feedback for the student on strengths and areas for improvement (appropriate to ${debateState.difficultyLevel} level)\n4. Specific feedback on what the agent did well\n5. Actionable advice for the student to improve at this level or advance to the next level\n\nFormat your response as JSON with this structure:\n{\n  "student_scores": {"arguments": X, "evidence": X, "clash": X, "organization": X, "delivery": X},\n  "agent_scores": {"arguments": X, "evidence": X, "clash": X, "organization": X, "delivery": X},\n  "winner": "student" or "agent",\n  "winner_reasoning": "...",\n  "student_feedback": "...",\n  "agent_feedback": "...",\n  "improvement_advice": "..."\n}`
                        }]
                    })
                });

                const data = await response.json();
                const feedbackText = data.content[0].text;
                
                // Try to parse JSON from the response
                let feedback;
                try {
                    const jsonMatch = feedbackText.match(/\{[\s\S]*\}/);
                    feedback = JSON.parse(jsonMatch[0]);
                } catch (e) {
                    feedback = {
                        student_scores: { arguments: 20, evidence: 20, clash: 20, organization: 20, delivery: 20 },
                        agent_scores: { arguments: 20, evidence: 20, clash: 20, organization: 20, delivery: 20 },
                        winner: "student",
                        winner_reasoning: "Unable to parse detailed feedback",
                        student_feedback: feedbackText,
                        agent_feedback: "See general feedback above",
                        improvement_advice: "Continue practicing debate fundamentals"
                    };
                }

                displayFeedback(feedback);
            } catch (error) {
                console.error('Error generating feedback:', error);
                document.getElementById('feedbackContent').innerHTML = 
                    '<div class="error-message">Error generating feedback. Please try again.</div>';
            }
        }

        function displayFeedback(feedback) {
            const studentTotal = Object.values(feedback.student_scores).reduce((a, b) => a + b, 0);
            const agentTotal = Object.values(feedback.agent_scores).reduce((a, b) => a + b, 0);

            const difficultyLabels = {
                'novice': 'ü•â Novice',
                'jv': 'ü•à Junior Varsity',
                'varsity': 'ü•á Varsity',
                'national': 'üèÜ National Circuit',
                'toc': 'üëë TOC/Elite'
            };

            const html = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 20px; border-radius: 20px; font-size: 1.1em; font-weight: 600;">
                        ${difficultyLabels[debateState.difficultyLevel]}
                    </span>
                </div>

                <div class="info-box">
                    <h3>üèÜ Winner: ${feedback.winner === 'student' ? debateState.studentName : 'Agent'}</h3>
                    <p>${feedback.winner_reasoning}</p>
                </div>

                <div class="feedback-card">
                    <h3 class="feedback-title">üìä ${debateState.studentName}'s Scores</h3>
                    <div class="score-grid">
                        <div class="score-item">
                            <div class="score-label">Arguments</div>
                            <div class="score-value">${feedback.student_scores.arguments}/30</div>
                        </div>
                        <div class="score-item">
                            <div class="score-label">Evidence</div>
                            <div class="score-value">${feedback.student_scores.evidence}/30</div>
                        </div>
                        <div class="score-item">
                            <div class="score-label">Clash</div>
                            <div class="score-value">${feedback.student_scores.clash}/30</div>
                        </div>
                        <div class="score-item">
                            <div class="score-label">Organization</div>
                            <div class="score-value">${feedback.student_scores.organization}/30</div>
                        </div>
                        <div class="score-item">
                            <div class="score-label">Delivery</div>
                            <div class="score-value">${feedback.student_scores.delivery}/30</div>
                        </div>
                        <div class="score-item">
                            <div class="score-label">Total</div>
                            <div class="score-value">${studentTotal}/150</div>
                        </div>
                    </div>
                    <div class="feedback-text">
                        <strong>Feedback:</strong><br>
                        ${feedback.student_feedback}
                    </div>
                </div>

                <div class="feedback-card">
                    <h3 class="feedback-title">ü§ñ Agent's Scores</h3>
                    <div class="score-grid">
                        <div class="score-item">
                            <div class="score-label">Arguments</div>
                            <div class="score-value">${feedback.agent_scores.arguments}/30</div>
                        </div>
                        <div class="score-item">
                            <div class="score-label">Evidence</div>
                            <div class="score-value">${feedback.agent_scores.evidence}/30</div>
                        </div>
                        <div class="score-item">
                            <div class="score-label">Clash</div>
                            <div class="score-value">${feedback.agent_scores.clash}/30</div>
                        </div>
                        <div class="score-item">
                            <div class="score-label">Organization</div>
                            <div class="score-value">${feedback.agent_scores.organization}/30</div>
                        </div>
                        <div class="score-item">
                            <div class="score-label">Delivery</div>
                            <div class="score-value">${feedback.agent_scores.delivery}/30</div>
                        </div>
                        <div class="score-item">
                            <div class="score-label">Total</div>
                            <div class="score-value">${agentTotal}/150</div>
                        </div>
                    </div>
                    <div class="feedback-text">
                        <strong>Feedback:</strong><br>
                        ${feedback.agent_feedback}
                    </div>
                </div>

                ${feedback.improvement_advice ? `
                <div class="feedback-card" style="border-left-color: #f5576c;">
                    <h3 class="feedback-title">üí° Path to Improvement</h3>
                    <div class="feedback-text">
                        ${feedback.improvement_advice}
                    </div>
                </div>
                ` : ''}
            `;

            document.getElementById('feedbackContent').innerHTML = html;
        }

        function resetDebate() {
            location.reload();
        }
    </script>
</body>
</html>
